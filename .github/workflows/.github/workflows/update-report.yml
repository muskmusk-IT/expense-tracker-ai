name: Update Expense Report

on:
  push:
    paths:
      - 'data/expenses.csv'
      - '.github/workflows/update-report.yml'
  schedule:
    - cron: "0 0 * * 0"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -V
          pip install --upgrade pip
          pip install pandas matplotlib

      - name: Show repo tree (debug)
        run: |
          pwd
          ls -R

      # Pakai Python inline, jadi gak peduli scripts/generate_report.py ada/tidak
      - name: Generate report (inline)
        run: |
          python - << 'PY'
          import os
          import pandas as pd
          import matplotlib.pyplot as plt

          csv_path = "data/expenses.csv"
          out_path = "data/weekly_report.png"

          if not os.path.exists(csv_path):
            print("âš ï¸ CSV tidak ditemukan, skip.")
            raise SystemExit(0)

          try:
            df = pd.read_csv(csv_path, names=["Tanggal","Toko","Kategori","Total"])
            df["Tanggal"] = pd.to_datetime(df["Tanggal"], errors="coerce")
            df["Total"] = pd.to_numeric(df["Total"], errors="coerce")
            df = df.dropna()

            if df.empty:
              print("âš ï¸ CSV kosong/setelah dibersihkan tidak ada data valid, skip.")
              raise SystemExit(0)

            weekly = df.groupby(pd.Grouper(key="Tanggal", freq="W"))["Total"].sum()

            plt.figure(figsize=(8,4))
            weekly.plot(kind="bar", title="Pengeluaran Mingguan")
            plt.ylabel("Total (Rp)")
            plt.tight_layout()
            plt.savefig(out_path)
            print(f"ðŸ“Š Berhasil bikin: {out_path}")
          except Exception as e:
            print("âŒ Error:", e)
            raise
          PY

      - name: Commit and Push Report
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add data/weekly_report.png || true
          git commit -m "Update weekly report" || echo "No changes to commit"
          git push
