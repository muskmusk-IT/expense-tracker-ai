<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Expense Tracker</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#f4f6fb;
}
.wrap{
  max-width:1000px;
  margin:40px auto;
  padding:20px;
}
.card{
  background:white;
  border-radius:16px;
  padding:24px;
  box-shadow:0 10px 30px rgba(0,0,0,.05);
}
h1{
  margin:0 0 10px 0;
}
select{
  padding:8px 12px;
  border-radius:8px;
  border:1px solid #ddd;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}
th,td{
  padding:10px;
  border-bottom:1px solid #eee;
}
th{
  background:#3b2b77;
  color:white;
}
.right{
  text-align:right;
}
.total-box{
  margin-top:20px;
  text-align:right;
  font-size:18px;
  font-weight:bold;
}
canvas{
  margin-top:30px;
}
</style>
</head>

<body>
<div class="wrap">
<div class="card">

<h1>Expense Tracker</h1>

<select id="monthSelect">
<option value="all">Semua</option>
<option value="0">Januari</option>
<option value="1">Februari</option>
<option value="2">Maret</option>
<option value="3">April</option>
<option value="4">Mei</option>
<option value="5">Juni</option>
<option value="6">Juli</option>
<option value="7">Agustus</option>
<option value="8">September</option>
<option value="9">Oktober</option>
<option value="10">November</option>
<option value="11">Desember</option>
</select>

<table>
<thead>
<tr>
<th>Tanggal</th>
<th>Deskripsi</th>
<th class="right">Total</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<div class="total-box">
Total Bulan Ini: <span id="totalText">Rp 0</span>
</div>

<canvas id="chart" height="100"></canvas>

</div>
</div>

<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT-Bbh2MRHdykki8llY8J4n0H3WIs21BE24v91LbYyOy7Sa3nnI7_hpyd8KHYEY_rjzTuzslf9W9J2U/pub?gid=0&single=true&output=csv';
const tbody = document.getElementById('tbody');
const totalText = document.getElementById('totalText');
const monthSelect = document.getElementById('monthSelect');
const ctx = document.getElementById('chart');

let chart;
let allData = [];

function formatIDR(n){
  return new Intl.NumberFormat('id-ID',{
    style:'currency',
    currency:'IDR',
    maximumFractionDigits:0
  }).format(n);
}

async function loadCSV(){
  const res = await fetch(CSV_URL+'?ts='+Date.now());
  const text = await res.text();

  if(!text.trim()) return [];

  return text.trim().split(/\r?\n/).map(row=>{
    const [Tanggal,Toko,Kategori,Total] = row.split(',');
    return {
      Tanggal,
      Deskripsi: `${Kategori} - ${Toko}`,
      Total: Number(Total || 0)
    };
  });
}

function renderTable(data){
  tbody.innerHTML='';
  let sum=0;

  data.forEach(row=>{
    sum+=row.Total;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${row.Tanggal}</td>
      <td>${row.Deskripsi}</td>
      <td class="right">${formatIDR(row.Total)}</td>
    `;
    tbody.appendChild(tr);
  });

  totalText.textContent = formatIDR(sum);
}

function renderChart(data){
  const monthly = Array(12).fill(0);

  allData.forEach(r=>{
    const d=new Date(r.Tanggal);
    monthly[d.getMonth()] += r.Total;
  });

  if(chart) chart.destroy();

  chart = new Chart(ctx,{
    type:'bar',
    data:{
      labels:["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"],
      datasets:[{
        label:'Total Pengeluaran',
        data:monthly
      }]
    },
    options:{
      plugins:{legend:{display:false}},
      scales:{
        y:{
          ticks:{
            callback:(value)=>'Rp '+value.toLocaleString('id-ID')
          }
        }
      }
    }
  });
}

function filterByMonth(month){
  if(month==='all') return allData;

  return allData.filter(r=>{
    const d=new Date(r.Tanggal);
    return d.getMonth()==month;
  });
}

async function init(){
  allData = await loadCSV();
  renderTable(allData);
  renderChart(allData);

  monthSelect.addEventListener('change',()=>{
    const filtered = filterByMonth(monthSelect.value);
    renderTable(filtered);
  });
}

init();
</script>

</body>
</html>
